name: Auto update README index

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Generate grouped notes index
        run: |
          find . -type f -name "*.md" \
            ! -path "./README.md" \
            ! -path "./INDEX.md" \
            ! -path "./.github/*" \
            | sort \
            | awk '
            function url_encode(str,    i, c, out) {
              out = ""
              for (i = 1; i <= length(str); i++) {
                c = substr(str, i, 1)

                # RFC 3986 unreserved characters
                if (c ~ /[A-Za-z0-9._~-]/) {
                  out = out c
                } else {
                  out = out "%" sprintf("%02X", ord(c))
                }
              }
              return out
            }

            function ord(c) {
              return index("\
\001\002\003\004\005\006\007\010\011\012\013\014\015\016\017\
\020\021\022\023\024\025\026\027\030\031\032\033\034\035\036\037\
 !\"#$%&'\''()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~", c) - 1
            }

            {
              path = substr($0, 3)
              n = split(path, parts, "/")
              group = parts[1]

              if (!(group in seen)) {
                if (NR > 1) print ""
                print "### " group
                seen[group] = 1
              }

              indent = ""
              for (i = 2; i < n; i++) indent = indent "  "

              file = parts[n]
              url = url_encode(path)

              print indent "- [" file "](" url ")"
            }' > INDEX.md

      - name: Commit and push if changed
        run: |
          if git diff --quiet; then
            echo "README unchanged"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md
          git commit -m "docs: auto update notes index (grouped)"
          git push
